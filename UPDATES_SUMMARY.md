# Avito CRM — Резюме обновлений проекта

> Период: 18 января 2026 — 9 февраля 2026
> Всего коммитов: 18 | PR: 7 | Авторы: vadimkabeats, andrrrrey, Claude

---

## Фаза 1: Создание проекта (18–27 января 2026)

**Автор:** vadimkabeats

### Инициализация (18 января)
- Создан проект на **Next.js 16** + **React 19** + **TypeScript**
- Настроены Tailwind CSS, ESLint, PostCSS

### Основная кодовая база (27 января)
Добавлена полная CRM-система за один коммит (~5 500 строк):

- **База данных (Prisma + PostgreSQL):**
  - Модели: Chat, Message, User, Session, IntegrationState, WebhookEvent
  - 5 миграций для эволюции схемы
  - Docker Compose для PostgreSQL

- **Бэкенд (API Routes):**
  - Аутентификация: login/logout/me с сессиями
  - Чаты: CRUD, отправка/получение сообщений, пометка прочитанными, закрепление, завершение
  - Avito: синхронизация чатов, обработка вебхуков
  - Бот: автоответы для BOT-чатов
  - Dev-утилиты: seed, reset, incoming-эмуляция, whoami
  - SSE (Server-Sent Events) для real-time обновлений

- **Фронтенд:**
  - Трёхколоночный дашборд (BOT-чаты | Менеджер-чаты | Детали переписки)
  - Страница логина
  - Сортировка по дате/цене, фильтр непрочитанных
  - Real-time обновления через SSE + polling

- **Библиотеки:**
  - `auth.ts` — аутентификация и сессии
  - `avito.ts` — клиент Avito API (OAuth, сообщения, чаты)
  - `bot.ts` — логика бот-ответов
  - `realtime.ts` — система SSE-событий
  - `env.ts` — валидация переменных окружения (Zod)
  - Middleware для проверки авторизации

---

## Фаза 2: Интеграция AI-ассистента (7–8 февраля 2026)

**PR #1** `feat: add AI assistant (ChatGPT) integration page`
- Новая модель БД `AiAssistant` (API key, assistant ID, vector store ID, инструкции, toggle вкл/выкл)
- Страница `/ai-assistant` с формой настроек и управлением файлами для vector store
- API: GET/PUT `/api/ai-assistant`, GET/POST/DELETE `/api/ai-assistant/files`
- Сервис `openai.ts` для работы с OpenAI API
- Навигационная ссылка «AI Ассистент» в хедере
- **+805 строк**

**PR #2** `feat: add ChatGPT auto-reply for BOT chats via OpenAI Assistants API`
- Функция `getAssistantReply()` — создание/переиспользование thread на чат, отправка сообщения, polling ответа
- Автоматический AI-ответ при входящем сообщении в BOT-чат (если ассистент включён)
- Отправка ответа обратно через Avito API (или локальное сохранение в mock-режиме)
- Пометка входящих как прочитанных после ответа бота
- Публикация SSE-событий для мгновенного обновления UI
- **+239 строк**

**PR #3** `fix: make AI reply non-blocking + add debug logging`
- AI-ответ переведён в fire-and-forget режим — вебхук сразу возвращает 200
- Предотвращение таймаута Avito (OpenAI обрабатывает 10–60 сек)
- Добавлено debug-логирование с префиксом `[AI]`
- **+19 / -12 строк**

---

## Фаза 3: Оптимизация доставки сообщений (8 февраля 2026)

**PR #4** `fix: устранить задержку 3-5 мин при получении сообщений из Avito`

Исправлены три проблемы:
1. **Блокировка вебхука:** API-вызовы Avito (enrichChatFromAvitoIfMissing, tryFillChatPrice) блокировали публикацию SSE-событий. Исправлено: SSE публикуются сразу после записи в БД, обогащение — в фоне
2. **Пропуск сообщений при SSE:** При подключённом SSE polling полностью отключался. Если SSE-событие терялось — сообщение не появлялось. Исправлено: фоновый polling 30с (чаты) / 15с (сообщения) как подстраховка
3. **Тихие пропуски AI:** Ассистент без логов пропускал обработку при status!=BOT. Добавлено логирование всех ранних выходов
- **+41 / -26 строк**

---

## Фаза 4: Мгновенная доставка и вебхуки (8 февраля 2026)

**PR #5** `feat: мгновенная доставка сообщений Avito + мгновенные AI-ответы`

Крупное обновление real-time системы:
- **API подписки на вебхуки** (`/api/avito/subscribe`) — мгновенное получение сообщений от Avito без polling
- **SSE chatSnapshot** — SSE-события содержат снимок чата для мгновенного обновления списка без повторных запросов
- **Оптимистичное обновление кэша** — фронтенд обновляет SWR-кэш из SSE
- **Звуковые уведомления** — Web Audio API при новых входящих
- **Индикатор вебхука** — статус + кнопка подключения/отключения в UI
- **Параллельный запуск AI** — ассистент запускается параллельно с dev-ботом
- **Новое SSE-событие `new_incoming`** — для глобальных уведомлений
- **+437 / -15 строк**

---

## Фаза 5: Стабилизация вебхуков (8–9 февраля 2026)

**PR #6** `fix: исправить вебхук-подписку Avito + добавить диагностику конфигурации`
- Исправлены эндпоинты: POST `/messenger/v3/webhook` (без account_id), обязательный параметр `secret`
- GET подписок через `/messenger/v1/subscriptions`
- Диагностика конфигурации (`/api/avito/subscribe` GET): проверка PUBLIC_BASE_URL, Avito credentials, AI config
- Панель диагностики в UI с бейджем количества проблем
- Индикатор AI ON/OFF в top bar
- Показ ошибок при подключении вебхука
- **+174 / -58 строк**

**PR #7** `fix: use cached state for webhook toggle when Avito GET check returns 404`
- Avito API не поддерживает GET для проверки статуса подписки (возвращает 404)
- Добавлен module-level кэш состояния подписки после успешных POST/DELETE
- Используется как fallback при неудачном GET
- **+33 / -3 строки**

---

## Сводная статистика

| Метрика | Значение |
|---------|----------|
| Общее число коммитов | 18 |
| Pull requests | 7 (все merged) |
| Период разработки | 23 дня |
| Активная разработка (Claude) | 3 дня (7–9 февраля) |
| Всего строк добавлено | ~14 000+ |
| Файлов затронуто | 50+ уникальных |

### По авторам

| Автор | Коммиты | Роль |
|-------|---------|------|
| vadimkabeats | 4 | Создание проекта, базовая архитектура |
| andrrrrey | 7 | Code review, merge PR |
| Claude | 7 | AI-интеграция, real-time, оптимизации, баг-фиксы |

---

## Текущее состояние проекта

Avito CRM — полнофункциональная CRM-система для работы с чатами Avito:

- **Real-time дашборд** с мгновенной доставкой сообщений через SSE + вебхуки
- **AI-ассистент (ChatGPT)** для автоматических ответов в BOT-чатах
- **Двухколоночная маршрутизация** — чаты BOT (автоответ) / MANAGER (ручная обработка)
- **Интеграция Avito API** — OAuth, чаты, сообщения, вебхуки
- **Аутентификация** с сессиями и ролями
- **Dev-режим** для тестирования без подключения к Avito
- **Диагностика** конфигурации и состояния вебхуков
